#!/usr/bin/env bash

set -eu

readonly DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"

for file in "$@"
do
    [[ ! -f "$file" ]] && continue

    # Perform in-place changes on files before running clang-format
    perl -i \
        -pe 's/\s+::/::/g;' \
        "$file"

    if [[ "$file" == *hpp ]]; then
        # Use Allman-style braces for `.hpp` files,
        # clang-format garbles the autogenerated `.hpp` format
        perl -i \
            -pe 's/namespace (\w+) {/namespace \1\n{/g;' \
            "$file"
    else
        # Remove extra newlines after preamble comment block
        awk 'BEGIN{RS="\n\n\n" ; ORS="\n\n";}{print}' "$file" > /tmp/"$file"
        mv /tmp/"$file" "$file"
    
        clang-format -i "$file"
    fi
done
