#!/usr/bin/env bash

set -eu

readonly DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
readonly NETWORK='dtn-network'
readonly FSW_CONTAINER='fprime-dtn'
readonly GDS_CONTAINER='fprime-gds'

if [[ $# -gt 0 ]]; then
    readonly DOCKER_MODE_ARG="$1"
else
    readonly DOCKER_MODE_ARG='-it'
fi

build()
{
    local CONTAINER="$1"
    docker rm -f "$CONTAINER" 2>/dev/null || true
    docker build -t "$CONTAINER" -f "$DIR"/fprime.dockerfile "$DIR"
}

run()
{
    local CONTAINER="$1"; shift
    local ENTRYPOINT="$1"; shift
    local IP="$1"; shift
    local MODE_ARG="$1"; shift
    local PUBLISH_ARG="$@"

    # `/dev/shm` is sized to support ION shared memory needs
    docker run \
        --shm-size=1gb \
        -v "$DIR"/DtnRef:/home/ptl/DtnRef \
        -v "$DIR"/entrypoint:/home/ptl/entrypoint \
        $MODE_ARG \
        --network dtn-network \
        --ip "10.0.0.$IP" \
        $PUBLISH_ARG \
        --name "$CONTAINER" \
        --entrypoint bash \
        "$CONTAINER" \
        -c "$ENTRYPOINT"
        #-c 'bash'
}

build "$FSW_CONTAINER"
build "$GDS_CONTAINER"

docker network rm "$NETWORK" 2>/dev/null || true
docker network create "$NETWORK" --subnet 10.0.0.0/8

# To attach to GDS: `docker attach fprime-gds`
run "$GDS_CONTAINER" 'entrypoint/gds-entrypoint 10.0.0.3 10.0.0.2 ; bash'        3 -dit
run "$FSW_CONTAINER" 'entrypoint/deployment-entrypoint 10.0.0.2 10.0.0.3 ; bash' 2 $DOCKER_MODE_ARG --publish 5555:5000
